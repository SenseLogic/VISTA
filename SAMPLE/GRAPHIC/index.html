<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Sample</title>
        <style>
        </style>
    </head>
    <body>
        <main>
            <canvas id="colored-triangle-canvas" width="640" height="480">
            </canvas>
            <canvas id="textured-cube-canvas" width="640" height="480">
            </canvas>
        </main>
        <script src="../../CODE/JAVASCRIPT/vista_base.js"></script>
        <script src="../../CODE/JAVASCRIPT/vista_math.js"></script>
        <script src="../../CODE/JAVASCRIPT/vista_vector_3.js"></script>
        <script src="../../CODE/JAVASCRIPT/vista_matrix_4.js"></script>
        <script src="../../CODE/JAVASCRIPT/vista_quaternion.js"></script>
        <script src="../../CODE/JAVASCRIPT/vista_element.js"></script>
        <script src="../../CODE/JAVASCRIPT/vista_graphic.js"></script>
        <script id="colored-triangle-vertex-shader" type="x-shader/x-vertex">
            attribute vec4 VertexPositionAttribute;
            attribute vec4 VertexColorAttribute;
            varying vec4 VertexColorVarying;

            void main(
                )
            {
                gl_Position = VertexPositionAttribute;
                VertexColorVarying = VertexColorAttribute;
            }
        </script>
        <script id="colored-triangle-fragment-shader" type="x-shader/x-fragment">
            precision mediump float;
            varying vec4 VertexColorVarying;

            void main(
                )
            {
                gl_FragColor = VertexColorVarying;
            }
        </script>
        <script id="textured-cube-vertex-shader" type="x-shader/x-vertex">
            attribute vec4 VertexPositionAttribute;
            attribute vec2 VertexMappingAttribute;
            uniform mat4 ModelMatrixUniform;
            uniform mat4 ViewProjectionMatrixUniform;
            varying highp vec2 VertexMappingVarying;

            void main(
                )
            {
                gl_Position = ViewProjectionMatrixUniform * ModelMatrixUniform * VertexPositionAttribute;
                VertexMappingVarying = VertexMappingAttribute;
            }
        </script>
        <script id="textured-cube-fragment-shader" type="x-shader/x-fragment">
            precision mediump float;
            varying highp vec2 VertexMappingVarying;
            uniform sampler2D TextureSamplerUniform;

            void main(
                )
            {
                gl_FragColor = texture2D( TextureSamplerUniform, VertexMappingVarying );
            }
        </script>
        <script>
            // -- FUNCTIONS

            async function RenderColoredTriangle(
                )
            {
                var
                    canvas,
                    vertex_color_attribute,
                    fragment_shader,
                    vertex_position_attribute,
                    program,
                    vertex_position_color_array_buffer,
                    vertex_shader;

                canvas = new GRAPHIC_CANVAS( GetElementById( "colored-triangle-canvas" ) );

                vertex_shader
                    = canvas.CreateVertexShader(
                          "colored-triangle-vertex-shader",
                          GetElementById( "colored-triangle-vertex-shader" ).text
                          );

                fragment_shader
                    = canvas.CreateFragmentShader(
                          "colored-triangle-fragment-shader",
                          GetElementById( "colored-triangle-fragment-shader" ).text
                          );

                program = canvas.CreateProgram( vertex_shader, fragment_shader );
                program.Use();

                vertex_position_color_array_buffer
                    = canvas.CreateReal32ArrayBuffer(
                          [
                              0.0, 0.5, 1.0, 0.0, 0.0,
                              -0.5, -0.5, 0.0, 1.0, 0.0,
                              0.5, -0.5, 0.0, 0.0, 1.0
                          ]
                          );

                vertex_position_attribute = program.GetAttribute( "VertexPositionAttribute" );
                vertex_position_attribute.SetReal32ArrayBuffer( vertex_position_color_array_buffer, 2, 5, 0 );

                vertex_color_attribute = program.GetAttribute( "VertexColorAttribute" );
                vertex_color_attribute.SetReal32ArrayBuffer( vertex_position_color_array_buffer, 3, 5, 2 );

                canvas.Clear( [ 0.9, 0.9, 0.9, 1.0 ] );
                canvas.DrawTriangles( 3 );
            }

            // ~~

            async function RenderTexturedCube(
                )
            {
                var
                    canvas,
                    element_array_buffer,
                    fragment_shader,
                    model_view_matrix,
                    perspective_matrix,
                    prior_time_stamp,
                    program,
                    rotation_speed_vector,
                    rotation_vector,
                    texture,
                    vertex_mapping_array_buffer,
                    vertex_mapping_attribute,
                    vertex_position_array_buffer,
                    vertex_position_attribute,
                    vertex_shader;

                canvas = new GRAPHIC_CANVAS( GetElementById( "textured-cube-canvas" ) );
                texture = canvas.CreateTexture();
                await texture.LoadImage( "texture_1.png" );

                vertex_shader
                    = canvas.CreateVertexShader(
                          "textured-cube-vertex-shader",
                          GetElementById( "textured-cube-vertex-shader" ).text
                          );

                fragment_shader
                    = canvas.CreateFragmentShader(
                          "textured-cube-fragment-shader",
                          GetElementById( "textured-cube-fragment-shader" ).text
                          );

                program = canvas.CreateProgram( vertex_shader, fragment_shader );
                program.VertexPositionAttribute = program.GetAttribute( "VertexPositionAttribute" );
                program.VertexMappingAttribute = program.GetAttribute( "VertexMappingAttribute" );
                program.TextureSamplerUniform = program.GetUniform( "TextureSamplerUniform" );
                program.ModelMatrixUniform = program.GetUniform( "ModelMatrixUniform" );
                program.ViewProjectionMatrixUniform = program.GetUniform( "ViewProjectionMatrixUniform" );

                vertex_position_array_buffer
                    = canvas.CreateReal32ArrayBuffer(
                          [
                              -0.5, 0.5, -0.5,
                              -0.5, 0.5, 0.5,
                              -0.5, -0.5, 0.5,
                              -0.5, -0.5, -0.5,
                              -0.5, 0.5, 0.5,
                              0.5, 0.5, 0.5,
                              0.5, -0.5, 0.5,
                              -0.5, -0.5, 0.5,
                              0.5, 0.5, 0.5,
                              0.5, 0.5, -0.5,
                              0.5, -0.5, -0.5,
                              0.5, -0.5, 0.5,
                              0.5, 0.5, -0.5,
                              -0.5, 0.5, -0.5,
                              -0.5, -0.5, -0.5,
                              0.5, -0.5, -0.5,
                              -0.5, 0.5, -0.5,
                              0.5, 0.5, -0.5,
                              0.5, 0.5, 0.5,
                              -0.5, 0.5, 0.5,
                              -0.5, -0.5, -0.5,
                              0.5, -0.5, -0.5,
                              0.5, -0.5, 0.5,
                              -0.5, -0.5, 0.5
                          ]
                          );

                vertex_mapping_array_buffer
                    = canvas.CreateReal32ArrayBuffer(
                          [
                              0.0, 0.0,
                              1.0, 0.0,
                              1.0, 1.0,
                              0.0, 1.0,
                              0.0, 0.0,
                              1.0, 0.0,
                              1.0, 1.0,
                              0.0, 1.0,
                              0.0, 0.0,
                              1.0, 0.0,
                              1.0, 1.0,
                              0.0, 1.0,
                              0.0, 0.0,
                              1.0, 0.0,
                              1.0, 1.0,
                              0.0, 1.0,
                              0.0, 0.0,
                              1.0, 0.0,
                              1.0, 1.0,
                              0.0, 1.0,
                              1.0, 0.0,
                              0.0, 0.0,
                              0.0, 1.0,
                              1.0, 1.0
                          ]
                          );

                element_array_buffer
                    = canvas.CreateNatural16ElementArrayBuffer(
                          [
                              2, 1, 0,
                              2, 0, 3,
                              6, 5, 4,
                              6, 4, 7,
                              10, 9, 8,
                              10, 8, 11,
                              14, 13, 12,
                              14, 12, 15,
                              18, 17, 16,
                              18, 16, 19,
                              22, 21, 20,
                              22, 20, 23
                          ]
                          );

                projection_matrix = GetPerspectiveMatrix4( 45.0 * DegreesToRadians, canvas.GetWidth() / canvas.GetHeight(), 0.1, 100.0 );
                view_matrix = GetTranslationMatrix4( GetVector3( 0.0, 0.0, -3.0 ) );
                view_projection_matrix = GetProductMatrix4( view_matrix, projection_matrix );

                program.Use();
                program.VertexPositionAttribute.SetReal32ArrayBuffer( vertex_position_array_buffer, 3 );
                program.VertexMappingAttribute.SetReal32ArrayBuffer( vertex_mapping_array_buffer, 2 );
                program.TextureSamplerUniform.BindTexture( texture, 0 );
                program.ViewProjectionMatrixUniform.SetRealMatrix4( view_projection_matrix );

                rotation_vector = GetVector3( 0.0 * DegreesToRadians, 0.0 * DegreesToRadians, 0.0 * DegreesToRadians );
                rotation_speed_vector = GetVector3( 3.0 * DegreesToRadians, 30.0 * DegreesToRadians, 1.0 * DegreesToRadians );

                function UpdateCanvas(
                    timestamp
                    )
                {
                    var
                        time_step;

                    time_step = prior_time_stamp ? ( timestamp - prior_time_stamp ) * 0.001 : 0.0;
                    prior_time_stamp = timestamp;

                    rotation_vector = GetScaledSumVector3( rotation_vector, rotation_speed_vector, 1.0, time_step );
                    model_matrix = GetZxyRotationMatrix4( rotation_vector );

                    canvas.Clear( [ 0.9, 0.9, 0.9, 1.0 ] );

                    program.ModelMatrixUniform.SetRealMatrix4( model_matrix );
                    canvas.DrawIndexedTriangles( 36 );

                    requestAnimationFrame( UpdateCanvas );
                }

                requestAnimationFrame( UpdateCanvas );
            }

            // -- STATEMENTS

            RenderColoredTriangle();
            RenderTexturedCube();
        </script>
    </body>
</html>
